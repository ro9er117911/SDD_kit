{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Slack Event Contracts for Spec Bot",
  "description": "Slack Event API 的 webhook 接收格式定義",
  "definitions": {
    "file_shared_event": {
      "$id": "#/definitions/file_shared_event",
      "title": "File Shared Event",
      "description": "使用者在 Slack 頻道上傳檔案的事件",
      "type": "object",
      "required": ["type", "event"],
      "properties": {
        "token": {
          "type": "string",
          "description": "Slack 驗證 token（已廢除，使用 signing_secret）"
        },
        "team_id": {
          "type": "string",
          "pattern": "^T[A-Z0-9]{10}$",
          "description": "Slack workspace ID"
        },
        "api_app_id": {
          "type": "string",
          "description": "Slack App ID"
        },
        "event": {
          "$ref": "#/definitions/file_shared_event_payload"
        },
        "type": {
          "const": "event_callback",
          "description": "事件類型，固定為 event_callback"
        },
        "event_id": {
          "type": "string",
          "pattern": "^Ev[A-Z0-9]{20}$",
          "description": "Slack 事件 ID，用於去重"
        },
        "event_time": {
          "type": "integer",
          "description": "事件發生時間戳記（Unix epoch）"
        }
      }
    },
    "file_shared_event_payload": {
      "$id": "#/definitions/file_shared_event_payload",
      "title": "File Shared Event Payload",
      "type": "object",
      "required": ["type", "file"],
      "properties": {
        "type": {
          "const": "file_shared",
          "description": "事件子類型"
        },
        "file": {
          "$ref": "#/definitions/file_object"
        }
      }
    },
    "file_object": {
      "$id": "#/definitions/file_object",
      "title": "Slack File Object",
      "type": "object",
      "required": ["id", "name", "size", "url_private"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^F[A-Z0-9]{10}$",
          "description": "Slack 檔案 ID"
        },
        "name": {
          "type": "string",
          "pattern": "\\.(md|MD)$",
          "description": "檔案名稱，必須為 .md 格式"
        },
        "size": {
          "type": "integer",
          "minimum": 1,
          "maximum": 102400,
          "description": "檔案大小（bytes），不超過 100 KB"
        },
        "url_private": {
          "type": "string",
          "format": "uri",
          "description": "檔案私有下載 URL"
        },
        "url_private_download": {
          "type": "string",
          "format": "uri",
          "description": "檔案私有下載 URL（完整）"
        },
        "mimetype": {
          "type": "string",
          "pattern": "^text/plain|text/markdown",
          "description": "MIME 類型"
        },
        "created": {
          "type": "integer",
          "description": "檔案建立時間戳記（Unix epoch）"
        }
      }
    },
    "app_mention_event": {
      "$id": "#/definitions/app_mention_event",
      "title": "App Mention Event",
      "description": "使用者 mention Bot 的事件",
      "type": "object",
      "required": ["type", "event"],
      "properties": {
        "token": {
          "type": "string"
        },
        "team_id": {
          "type": "string",
          "pattern": "^T[A-Z0-9]{10}$"
        },
        "api_app_id": {
          "type": "string"
        },
        "event": {
          "$ref": "#/definitions/app_mention_event_payload"
        },
        "type": {
          "const": "event_callback"
        },
        "event_id": {
          "type": "string"
        },
        "event_time": {
          "type": "integer"
        }
      }
    },
    "app_mention_event_payload": {
      "$id": "#/definitions/app_mention_event_payload",
      "title": "App Mention Event Payload",
      "type": "object",
      "required": ["type", "user", "channel", "text"],
      "properties": {
        "type": {
          "const": "app_mention",
          "description": "事件子類型"
        },
        "user": {
          "type": "string",
          "pattern": "^U[A-Z0-9]{10}$",
          "description": "提及 Bot 的使用者 ID"
        },
        "channel": {
          "type": "string",
          "pattern": "^[CG][A-Z0-9]{10}$",
          "description": "頻道 ID（C 開頭為公開頻道，G 開頭為私人群組）"
        },
        "thread_ts": {
          "type": "string",
          "pattern": "^\\d+\\.\\d{6}$",
          "description": "訊息執行緒時戳（若為執行緒回覆）"
        },
        "ts": {
          "type": "string",
          "pattern": "^\\d+\\.\\d{6}$",
          "description": "訊息時戳"
        },
        "text": {
          "type": "string",
          "description": "訊息文本，必須包含對 Bot 的提及"
        }
      }
    },
    "url_verification_challenge": {
      "$id": "#/definitions/url_verification_challenge",
      "title": "URL Verification Challenge",
      "description": "Slack URL 驗證請求（用於初始 webhook 設定）",
      "type": "object",
      "required": ["type", "challenge"],
      "properties": {
        "type": {
          "const": "url_verification",
          "description": "事件類型"
        },
        "challenge": {
          "type": "string",
          "description": "驗證字串，需原樣回覆"
        },
        "team_id": {
          "type": "string",
          "pattern": "^T[A-Z0-9]{10}$"
        },
        "api_app_id": {
          "type": "string"
        },
        "event_id": {
          "type": "string"
        },
        "event_time": {
          "type": "integer"
        }
      }
    }
  },
  "oneOf": [
    {
      "title": "BRD 檔案上傳事件",
      "description": "PM 上傳 BRD 檔案觸發的事件",
      "type": "object",
      "required": ["type", "event", "team_id"],
      "properties": {
        "type": {
          "const": "event_callback"
        },
        "team_id": {
          "type": "string",
          "pattern": "^T[A-Z0-9]{10}$"
        },
        "api_app_id": {
          "type": "string"
        },
        "event_id": {
          "type": "string",
          "pattern": "^Ev[A-Z0-9]{20}$"
        },
        "event_time": {
          "type": "integer"
        },
        "event": {
          "type": "object",
          "required": ["type", "file"],
          "properties": {
            "type": {
              "const": "file_shared"
            },
            "file": {
              "type": "object",
              "required": ["id", "name", "size"],
              "properties": {
                "id": {
                  "type": "string",
                  "pattern": "^F[A-Z0-9]{10}$"
                },
                "name": {
                  "type": "string",
                  "pattern": "\\.(md|MD)$",
                  "maxLength": 255
                },
                "size": {
                  "type": "integer",
                  "minimum": 1,
                  "maximum": 102400
                },
                "url_private": {
                  "type": "string",
                  "format": "uri"
                },
                "url_private_download": {
                  "type": "string",
                  "format": "uri"
                },
                "mimetype": {
                  "type": "string"
                },
                "created": {
                  "type": "integer"
                },
                "timestamp": {
                  "type": "integer"
                }
              }
            }
          }
        }
      }
    },
    {
      "title": "Bot Mention 事件",
      "description": "使用者在訊息中 mention Bot 的事件",
      "type": "object",
      "required": ["type", "event", "team_id"],
      "properties": {
        "type": {
          "const": "event_callback"
        },
        "team_id": {
          "type": "string",
          "pattern": "^T[A-Z0-9]{10}$"
        },
        "api_app_id": {
          "type": "string"
        },
        "event_id": {
          "type": "string"
        },
        "event_time": {
          "type": "integer"
        },
        "event": {
          "type": "object",
          "required": ["type", "user", "channel", "text"],
          "properties": {
            "type": {
              "const": "app_mention"
            },
            "user": {
              "type": "string",
              "pattern": "^U[A-Z0-9]{10}$"
            },
            "channel": {
              "type": "string",
              "pattern": "^[CG][A-Z0-9]{10}$"
            },
            "thread_ts": {
              "type": "string",
              "pattern": "^\\d+\\.\\d{6}$"
            },
            "ts": {
              "type": "string",
              "pattern": "^\\d+\\.\\d{6}$"
            },
            "text": {
              "type": "string"
            }
          }
        }
      }
    },
    {
      "title": "URL 驗證請求",
      "description": "Slack 初始設定時的 URL 驗證",
      "$ref": "#/definitions/url_verification_challenge"
    }
  ],
  "examples": [
    {
      "title": "BRD 檔案上傳事件範例",
      "value": {
        "token": "deprecated_token_not_used",
        "team_id": "T12345678AB",
        "api_app_id": "A12345678AB",
        "event": {
          "type": "file_shared",
          "file": {
            "id": "F12345678AB",
            "name": "新功能_BRD.md",
            "size": 8192,
            "url_private": "https://files.slack.com/files-pri/T12345678AB-F12345678AB/xxxxxxxxxxx/新功能_BRD.md",
            "url_private_download": "https://files.slack.com/files-pri/T12345678AB-F12345678AB/download/新功能_BRD.md",
            "mimetype": "text/plain",
            "created": 1731502222,
            "timestamp": 1731502222
          }
        },
        "type": "event_callback",
        "event_id": "Ev12345678AB123456789012",
        "event_time": 1731502222
      }
    },
    {
      "title": "Bot Mention 事件範例",
      "value": {
        "token": "deprecated_token_not_used",
        "team_id": "T12345678AB",
        "api_app_id": "A12345678AB",
        "event": {
          "type": "app_mention",
          "user": "U12345678AB",
          "channel": "C12345678AB",
          "ts": "1731502222.000100",
          "thread_ts": "1731502222.000100",
          "text": "<@U12345678XY> 請生成 SDD"
        },
        "type": "event_callback",
        "event_id": "Ev12345678AB123456789012",
        "event_time": 1731502222
      }
    },
    {
      "title": "URL 驗證請求範例",
      "value": {
        "type": "url_verification",
        "challenge": "3eZbrw1aBrHwDZVV5EMm2chNmE1DhSv3IYhJPu9AeWcJCXdL6Bvv8ZPDF6pS3b1D",
        "team_id": "T12345678AB",
        "api_app_id": "A12345678AB",
        "event_id": "Ev12345678AB123456789012",
        "event_time": 1731502222
      }
    }
  ]
}
