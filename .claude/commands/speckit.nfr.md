---
description: 從專案上下文產生非功能需求文件（70_nfr.md），包含效能、可用性、可靠性、維運、擴展性、安全性與合規性需求。
---

## 使用者輸入

```text
$ARGUMENTS
```

## 流程總覽

此命令用於定義**非功能需求（NFR）**,是 Bank Profile 需求對齊層的最後一個文件。應在完成所有功能與合規文件後執行。

## 目標定位

**70_nfr.md 關注**：
- HOW-FAST：系統要多快（效能、回應時間）
- HOW-AVAILABLE：系統要多可靠（可用性、SLA）
- HOW-RECOVER：災難如何復原（RTO/RPO）
- HOW-MONITOR：如何監控維運（監控、告警）
- HOW-SCALE：如何擴展（擴展性、容量）
- HOW-SECURE：如何保護（安全性、合規性）

**NOT in scope**：HOW-TO-IMPLEMENT（屬於 spec.md 與 plan.md）

## 執行步驟

### 1. 初始設定與上下文載入

1. **載入相關文件**：
   - `10_business.md`（業務目標、使用者期望）
   - `20_process.md`（流程步驟、時間要求）
   - `30_risk_control.md`（風險控制、KRI）
   - `40_infosec.md`（資安需求）
   - `50_compliance.md`（法遵需求）
   - `60_audit.md`（稽核需求）
   - 設定 NFR_DIR = `$REPO_ROOT/specs/nfr`

2. **檢查既有文件**：若存在詢問 yes/no/merge

### 2. 智能問答（8 個問題）

**第 1 層：效能需求 (P0)**

1. **Q1: 回應時間期望**
   ```
   使用者期望系統操作的回應時間是多少？

   **從 20_process.md 推導**（各步驟的時間要求）:

   流程步驟 → 回應時間需求：
   | 流程步驟 | 推導的回應時間 | 優先級 |
   |---------|---------------|--------|
   | [步驟 1] | < [X] 秒 | P0/P1 |
   | [步驟 2] | < [X] 秒 | P0/P1 |

   **範例（STR/SAR）**：
   | 流程步驟 | 推導的回應時間 | 優先級 |
   |---------|---------------|--------|
   | 單筆 STR 摘要生成 | < 5 秒 | P0 |
   | STR 個案資料查詢 | < 2 秒 | P0 |
   | 分析人員儀表板載入 | < 3 秒 | P1 |

   **一般使用者期望**：
   - 即時互動：< 2 秒（使用者無感知延遲）
   - 可接受：< 5 秒（使用者可忍受）
   - 批次處理：5-30 秒（需顯示進度）

   請確認回應時間需求（yes/modify）
   ```

2. **Q2: 吞吐量與容量需求**
   ```
   系統需要支援多少使用量？

   **從 10_business.md 推導**（使用者數量、業務量）:
   - 使用者數量：[X] 人（同時在線 [Y] 人）
   - 業務量：每日 [Z] 筆案件處理

   **從業務目標推導吞吐量需求**:
   | 容量指標 | 推導值 | 來源 |
   |---------|-------|------|
   | 每日案件處理量 | [N] 筆/日 | 10_business.md |
   | 並行請求數 | [M] 並行 | 使用者數量 / 10 |
   | 資料儲存成長 | [X] GB/年 | 案件數 × 平均大小 |

   **範例（STR/SAR）**：
   | 容量指標 | 推導值 | 來源 |
   |---------|-------|------|
   | 每日 STR 摘要生成 | 1,000 筆/日 | 業務需求 |
   | 並行模型推論請求 | 10 並行 | 20 使用者 / 2 |
   | 稽核日誌成長 | 100 GB/年 | 案件數 × 日誌大小 |

   請確認容量需求（yes/modify）
   ```

**第 2 層：可用性與可靠性 (P0)**

3. **Q3: 服務可用性要求（SLA）**
   ```
   系統需要達到什麼可用性目標？

   **從業務重要性推導**:
   - 關鍵業務系統：99.9%（約 8.76 小時停機/年）
   - 重要業務系統：99.5%（約 43.8 小時停機/年）
   - 一般業務系統：99.0%（約 87.6 小時停機/年）

   **從 30_risk_control.md 推導**（系統中斷風險等級）:
   - 風險等級：[高/中/低]
   - 建議 SLA：[99.9% / 99.5% / 99.0%]

   **適用時段**:
   - 24×7（全天候）
   - 工作時段（09:00-19:00，週一至週五）

   **推薦（STR/SAR）**：
   - 核心功能（STR 摘要系統）：99.5%，工作時段
   - 降級模式（人工撰寫）：99.9%，工作時段

   請選擇 SLA 目標（或 'yes' 接受推薦）
   ```

4. **Q4: 災難復原需求（RTO/RPO）**
   ```
   系統故障時，需要多快復原？可容忍多少資料遺失？

   **從 30_risk_control.md 推導**（業務中斷影響）:
   - 業務中斷風險等級：[高/中/低]
   - 建議 RTO：[2 小時 / 4 小時 / 8 小時]
   - 建議 RPO：[0 / 15 分鐘 / 1 小時]

   **從 50_compliance.md 推導**（法規要求）:
   - 法規是否要求資料不可遺失：是/否
   - 若是 → RPO = 0

   **推薦（STR/SAR）**：
   | 系統/資料 | RTO | RPO | 理由 |
   |---------|-----|-----|------|
   | STR 摘要服務 | 4 小時 | 0 | 法規要求不可遺失已確認摘要 |
   | 模型推論服務 | 4 小時 | 可重新產生 | 模型輸出可重算 |
   | 稽核日誌 | 4 小時 | 0 | 法規要求不可遺失 |

   請確認 RTO/RPO（yes/modify）
   ```

**第 3 層：維運與監控 (P1)**

5. **Q5: 監控與告警需求**
   ```
   需要監控哪些指標？何時告警？

   **從 30_risk_control.md 推導**（KRI 需要的監控指標）:
   | KRI | 對應監控指標 | 建議告警門檻 |
   |-----|-------------|-------------|
   | [KRI-001] | [監控指標] | [門檻] |

   **範例（STR/SAR）**：
   | KRI | 對應監控指標 | 建議告警門檻 |
   |-----|-------------|-------------|
   | 模型錯誤率 < 5% | 模型服務錯誤率 | > 5% |
   | 異常存取次數 < 10/日 | 異常時段存取次數 | > 10/日 |
   | 系統可用率 > 99.5% | 系統可用性 | < 99.5% |

   **標準監控指標**（建議）:
   - 系統資源（CPU、記憶體、磁碟）
   - 應用效能（API 回應時間、錯誤率）
   - 業務指標（處理量、成功率）

   請確認監控指標（或 'standard' 使用標準監控）
   ```

6. **Q6: 健康檢查需求**
   ```
   系統需要提供健康檢查 API 嗎？

   **常見需求**:
   - A：簡單健康檢查（GET /health 回傳 status）
   - B：詳細健康檢查（包含版本、運行時間、依賴服務狀態）
   - C：整合健康檢查（檢查資料庫、模型服務、日誌系統等）
   - D：不需要

   **推薦**: C（整合健康檢查）- 用於負載平衡器、監控系統

   請選擇健康檢查需求（或 'yes' 接受推薦）
   ```

**第 4 層：擴展性與成長 (P2)**

7. **Q7: 擴展性需求**
   ```
   系統需要支援未來成長嗎？預期成長多少？

   **從 10_business.md 推導**（業務成長預期）:
   - 目前使用者數：[N] 人
   - 3 年後預期：[M] 人（成長 [X]%）
   - 目前業務量：[P] 筆/日
   - 3 年後預期：[Q] 筆/日（成長 [Y]%）

   **擴展方式**:
   - 水平擴展（增加伺服器實例）
   - 垂直擴展（增加單機資源）
   - 分散式架構（資料分片）

   **推薦**: 水平擴展（雲端環境適用）

   請確認擴展性需求（或 'later' 稍後補充）
   ```

**第 5 層：安全性與合規性 (整合既有文件)**

8. **Q8: 模型治理需求**（AI/ML 專案特有）
   ```
   模型版本如何管理？如何監控模型品質？

   **模型版本管理**:
   - A：手動部署（人工控制）
   - B：半自動部署（IaC + 審核流程）
   - C：全自動部署（CI/CD + 自動測試）
   - D：不適用（非 AI/ML 專案）

   **推薦**: B（半自動部署 + 審核）- 平衡效率與控制

   **模型品質監控**:
   - 模型信心分數分布
   - 模型建議被修改率
   - 模型推論錯誤率

   請選擇模型治理方式（或 'yes' 接受推薦）
   ```

### 3. 自動生成內容

**效能需求生成**：
- 從 20_process.md 的流程步驟生成回應時間需求
- 從 10_business.md 的使用者數量推導並行需求
- 從業務量推導吞吐量需求
- 生成 NFR-PERF-*, NFR-CAP-* 編號

**可用性需求生成**：
- 從業務重要性推導 SLA 目標
- 從 30_risk_control.md 的風險等級推導 RTO/RPO
- 從 50_compliance.md 的法規要求調整 RPO
- 生成 NFR-AVAIL-*, NFR-DR-* 編號

**監控需求生成**：
- 從 30_risk_control.md 的 KRI 生成監控指標
- 從風險等級推導告警門檻
- 生成標準監控指標（CPU、記憶體、錯誤率等）
- 生成 NFR-MON-* 編號

**安全性與合規性 NFR 整合**：
- 從 40_infosec.md 整合安全性 NFR（傳輸加密、靜態加密、密碼強度等）
- 從 50_compliance.md 整合合規性 NFR（個資法、洗錢防制法等）
- 生成 NFR-SEC-*, NFR-COMP-* 編號

**擴展性需求生成**：
- 從 10_business.md 的成長預期生成未來容量需求
- 推導擴展方式（水平/垂直）
- 生成 NFR-SCALE-* 編號

**模型治理 NFR 生成**（AI/ML 專案）：
- 模型版本控制（IaC、Git）
- 模型變更審核流程
- 模型效能監控指標
- 生成 NFR-MODEL-* 編號

### 4. 整合既有文件

**從 20_process.md 整合流程時間**：
- 流程步驟耗時 → 回應時間需求
- 關鍵步驟 → 效能 P0 需求

**從 30_risk_control.md 整合風險與 KRI**：
- 業務中斷風險 → RTO/RPO 需求
- KRI → 監控指標與告警門檻
- 控制措施 → NFR（如：備份、監控）

**從 40_infosec.md 整合資安需求**：
- 傳輸加密 → NFR-SEC-001
- 靜態加密 → NFR-SEC-002
- Session 逾時 → NFR-SEC-004
- API 速率限制 → NFR-SEC-005

**從 50_compliance.md 整合法遵需求**：
- 個資法 → NFR-COMP-001
- 洗錢防制法 → NFR-COMP-002
- 稽核可追溯性 → NFR-COMP-003

**從 60_audit.md 整合稽核需求**：
- 日誌寫入效能 → NFR-CAP-004
- 日誌查詢效能 → NFR-PERF-004/005
- 日誌保留期限 → 儲存容量需求

### 5. NFR 優先級排序

**自動分配優先級**：

依據影響範圍與風險等級：
- **P0（最高）**：
  - 涉及法規遵循（NFR-COMP-*）
  - 資料可靠性（NFR-DR-001: RPO=0）
  - 核心功能可用性（NFR-AVAIL-004）

- **P1（高）**：
  - 效能（影響使用者體驗）
  - 安全性（資料保護）
  - 稽核性（證據留存）

- **P2（中）**：
  - 擴展性（長期需求）
  - 監控（維運需求）
  - 使用性（體驗優化）

- **P3（低）**：
  - 無障礙（Nice to have）
  - 多語言支援

### 6. NFR 測試策略生成

**自動生成測試需求**：

效能測試：
- 負載測試場景（模擬正常負載）
- 壓力測試場景（模擬尖峰負載）
- 容量測試場景（驗證吞吐量）

可用性測試：
- SLA 驗證（監控 1 個月）
- 降級測試（模擬服務故障）
- 災難復原演練（驗證 RTO/RPO）

安全性測試：
- 漏洞掃描（OWASP Top 10）
- 滲透測試（專業資安公司）
- 安全配置檢查（TLS 版本等）

### 7. 品質檢查

**完整性檢查**：
- [ ] 至少定義 15 個 NFR
- [ ] 涵蓋效能、可用性、可靠性、維運、擴展性
- [ ] 每個 NFR 有明確測量方式與驗證方式
- [ ] RTO/RPO 需求明確
- [ ] 監控指標與告警門檻完整

**一致性檢查**：
- [ ] 效能需求與 20_process.md 的流程時間對齊
- [ ] RTO/RPO 與 30_risk_control.md 的風險等級一致
- [ ] 安全性 NFR 與 40_infosec.md 一致
- [ ] 合規性 NFR 與 50_compliance.md 一致
- [ ] 監控指標與 30_risk_control.md 的 KRI 對齊

**可測試性檢查**：
- [ ] 每個 NFR 可測試（有明確測量方式）
- [ ] 效能需求有對應的測試場景
- [ ] 可用性目標可透過監控驗證

### 8. 生成 70_nfr.md

1. 載入模板並填寫所有自動生成內容
2. 插入效能需求、可用性需求、可靠性需求
3. 填入監控指標、健康檢查需求
4. 整合安全性與合規性 NFR（引用 40/50）
5. 插入擴展性需求、模型治理 NFR
6. 生成 NFR 優先級排序與測試策略

### 9. 輸出訊息

```
✅ 非功能需求文件已生成

📄 檔案路徑: specs/nfr/70_nfr.md

📊 NFR 摘要:
  ✓ 總計 NFR: [N] 個
    - 效能需求（NFR-PERF-*）: [X] 個
    - 容量需求（NFR-CAP-*）: [Y] 個
    - 可用性需求（NFR-AVAIL-*）: [Z] 個
    - 災難復原（NFR-DR-*）: [A] 個
    - 監控需求（NFR-MON-*）: [B] 個
    - 安全性需求（NFR-SEC-*）: [C] 個（整合自 40_infosec.md）
    - 合規性需求（NFR-COMP-*）: [D] 個（整合自 50_compliance.md）
    - 擴展性需求（NFR-SCALE-*）: [E] 個
    - 模型治理（NFR-MODEL-*）: [F] 個

🎯 關鍵 NFR:
  - NFR-PERF-001: 單筆 STR 摘要生成 < 5 秒（P0）
  - NFR-AVAIL-001: 系統可用性 99.5%（P0）
  - NFR-DR-001: RTO 4 小時、RPO 0（P0）
  - NFR-MON-001: 模型錯誤率監控 > 5% 告警（P1）

📈 SLA 與 RTO/RPO:
  - SLA 目標: 99.5%（工作時段）
  - RTO: 4 小時
  - RPO: 0（已確認摘要不可遺失）

⚙️ 擴展性:
  - 支援 3 年成長（業務量 3 倍）
  - 水平擴展設計（至少 10 實例）

⚠️ 高優先級 NFR (P0):
  - [NFR-COMP-*]: 合規性不可妥協
  - [NFR-DR-001]: 資料不可遺失
  - [NFR-AVAIL-004]: 核心功能持續可用

💡 下一步建議:
  1. 與 IT 部門確認 NFR 技術可行性
  2. 規劃效能測試與災難復原演練
  3. 執行 `/speckit.specify --from-bank-profile` 產生技術規格
  4. 或執行 `/speckit.plan` 開始實作規劃
```

## 與其他命令的整合

- **10_business.md** 的業務目標 → **70_nfr.md** 的效能期望
- **20_process.md** 的流程步驟 → **70_nfr.md** 的回應時間需求
- **30_risk_control.md** 的 KRI → **70_nfr.md** 的監控指標
- **40_infosec.md** 的資安控制 → **70_nfr.md** 的安全性 NFR
- **50_compliance.md** 的法遵要求 → **70_nfr.md** 的合規性 NFR
- **60_audit.md** 的稽核需求 → **70_nfr.md** 的日誌效能需求

## 特殊模式

### 快速模式 (--quick)
- 僅問 4 題（Q1, Q3, Q4, Q5）
- 使用標準 NFR 模板（99.5% SLA, 4 小時 RTO）

### 高可用模式 (--high-availability)
- 自動選擇最高 SLA（99.9%）
- RTO < 2 小時、RPO = 0
- 全面監控與告警

### 從需求繼承 (--from-bank-profile)
- 從 00-60 所有文件自動推導 NFR
- 減少問答至 2-3 題（僅確認關鍵數值）

## 案例：STR/SAR 摘要模型

輸入: `/speckit.nfr`

系統推導：
1. **效能需求**:
   - NFR-PERF-001: 單筆 STR 摘要生成 < 5 秒
   - NFR-PERF-002: STR 個案查詢 < 2 秒
   - NFR-CAP-001: 每日至少 1,000 筆處理
2. **可用性需求**:
   - NFR-AVAIL-001: 核心系統 99.5%（工作時段）
   - NFR-AVAIL-004: 降級模式（人工撰寫）99.9%
3. **災難復原**:
   - NFR-DR-001: RTO 4 小時、RPO 0（摘要不可遺失）
   - NFR-DR-003: 稽核日誌 RTO 4 小時、RPO 0
4. **監控需求**:
   - NFR-MON-001: 模型錯誤率 > 5% 告警
   - NFR-MON-002: 模型逾時比例 > 10% 告警
   - NFR-MON-004: 系統可用性 < 99.5% 告警
5. **模型治理**:
   - NFR-MODEL-001: 模型版本 IaC 管理
   - NFR-MODEL-002: 模型更新前需完成 UAT
   - NFR-MODEL-004: 可回退至前 3 個版本

## 注意事項

1. **NFR 可測試性**：所有 NFR 必須有明確測量方式，否則無法驗證
2. **NFR 優先級**：合規性 > 可用性 > 效能，資源衝突時依優先級取捨
3. **RTO/RPO 成本**：RPO=0 需要即時同步，成本較高，需評估必要性
4. **監控告警**：告警過多會造成「告警疲勞」，需設定合理門檻
5. **整合既有文件**：安全性、合規性 NFR 已在 40/50 定義，避免重複
