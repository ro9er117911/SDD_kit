version: '3.8'

services:
  spec-bot-worker:
    build:
      context: ..
      dockerfile: docker/spec-bot-sandbox/Dockerfile
    image: spec-bot-sandbox:latest
    container_name: spec-bot-worker

    # 資源限制
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '0.5'
          memory: 512M

    # 掛載點
    volumes:
      - type: bind
        source: ${INPUT_DIR:-./input}
        target: /input
        read_only: true
      - type: bind
        source: ${OUTPUT_DIR:-./output}
        target: /output
      - type: bind
        source: ${WORKSPACE_DIR:-./workspace}
        target: /workspace
      - type: bind
        source: ../.claude
        target: /workspace/.claude
        read_only: true

    # 環境變數
    environment:
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - CORRELATION_ID=${CORRELATION_ID}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}

    # 網路配置
    networks:
      - spec-bot-net

    # 生命週期配置
    restart: "no"
    stop_grace_period: 30s

    # 健康檢查
    healthcheck:
      test: ["CMD", "echo", "healthy"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # 工作目錄
    working_dir: /workspace

    # 預設命令（由外部覆蓋）
    command: ["bash", "-c", "echo 'Spec Bot Worker Ready'"]

networks:
  spec-bot-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
