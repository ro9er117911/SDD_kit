description = "執行非破壞性的跨 artifact 一致性與品質分析（在 `/spec.md`、`/plan.md`、`/tasks.md` 之間），於產生 tasks 之後執行。"

prompt = """
---
description: 執行非破壞性的跨 artifact 一致性與品質分析（在 `/spec.md`、`/plan.md`、`/tasks.md` 之間），於產生 tasks 之後執行。
---

## 使用者輸入

```text
$ARGUMENTS
```

在繼續之前**必須**考慮使用者輸入（若非空）。

## 目標

識別不一致、重複、模糊，以及三個核心產物（`spec.md`、`plan.md`、`tasks.md`）中規格不足的項目。本命令**必須**在 `/speckit.tasks` 成功產出完整 `tasks.md` 之後執行。

## 操作限制

**嚴格唯讀**：不要修改任何檔案。輸出一份結構化的分析報告。可選提供補救計畫（除非使用者明確批准，否則不要自動修改檔案）。

**憲法權威**：專案憲法（`.specify/memory/constitution.md`）在此分析範圍內為**不可協商**的依據。任何與憲法衝突之處視為 **CRITICAL**（危急），需調整 spec、plan 或 tasks（不能淡化、重解釋或忽略該原則）。若確實需要變更憲法，必須另行在獨立流程中清楚改動憲法。

## 執行步驟

### 1. 初始化分析上下文

從 repo root 執行一次：
```
.specify/scripts/bash/check-prerequisites.sh --json --require-tasks --include-tasks
```
解析回傳 JSON 以取得 FEATURE_DIR 和 AVAILABLE_DOCS。推導絕對路徑：

- SPEC = FEATURE_DIR/spec.md  
- PLAN = FEATURE_DIR/plan.md  
- TASKS = FEATURE_DIR/tasks.md

若任一檔案遺失則中止並回報錯誤（提示使用者先執行缺少的前置命令）。  
（注意：有單引號的參數示例，請依 shell 逃脫規則處理，例如 `'I'''m Groot'` 或用雙引號）。

### 2. 載入產物（逐步揭露）

僅讀取每份檔案中必要之最小內容：

**從 spec.md：**

- 概述/情境  
- 功能性需求  
- 非功能性需求  
- 使用者故事  
- 邊界與例外（若有）

**從 plan.md：**

- 架構 / 技術棧選擇  
- 資料模型參考  
- 階段 (phases)  
- 技術限制

**從 tasks.md：**

- 任務 ID  
- 任務描述  
- 階段分組  
- 平行標記 `[P]`  
- 參考檔案路徑

**從 constitution：**

- 載入 `.specify/memory/constitution.md` 以驗證原則

### 3. 建立語意模型（內部表示）

建立內部結構但**不在輸出中包含原始 artifact**：

- **需求清單（Requirements inventory）**：將每個功能與非功能需求制成條目並給予穩定 key（slug），如 `user-can-upload-file`。  
- **使用者故事 / 動作清單**：列出可驗收的使用者行為與對應驗收標準。  
- **任務覆蓋對照（Task coverage mapping）**：將每個任務映射到 1+ 個需求或故事（可由關鍵字或顯式引用推論）。  
- **憲法規則集**：抽出原則名稱與 MUST/SHOULD 類型的規範性敘述。

### 4. 偵測通過（Token 節省導向）

專注於高訊號發現。限制最多 50 項發現；超出匯總在溢位摘要中。

#### A. 重複偵測  
- 找出近似重複的需求，標示為需合併的候選。  

#### B. 模糊偵測  
- 標記含有模糊形容詞（例如：`fast`、`scalable`、`secure`、`intuitive`、`robust`）但缺乏衡量指標的地方。  
- 標記未解析的佔位符（TODO、TKTK、???、`<placeholder>` 等）。

#### C. 規格不足  
- 有動詞但缺乏對象或可衡量結果之需求。  
- 使用者故事缺少驗收標準。  
- 任務引用 spec/plan 未定義的檔案或元件。

#### D. 憲法對齊  
- 任何與憲法 MUST 衝突的需求或計畫元素皆為 CRITICAL。  
- 檢查是否遺漏憲法要求的必要段落或品質門檻。

#### E. 覆蓋缺口  
- 需求未被任何任務覆蓋。  
- 任務沒有對應的需求或使用者故事。  
- 非功能需求（效能、安全等）未反映到任務中。

#### F. 不一致  
- 術語漂移（同一概念於不同檔案以不同名稱出現）。  
- 計畫中提及的資料實體在 spec 中缺失，或相反。  
- 任務順序矛盾（例如：整合任務在基礎建設之前卻無依賴標註）。  
- 相互矛盾的技術選擇（例如一處要求 Next.js、另一處要求 Vue）。

### 5. 嚴重度評分

採用下列啟發式：

- **CRITICAL**：違反憲法 MUST、缺少核心規格、或需求無任何覆蓋且阻斷基線功能。  
- **HIGH**：重複或衝突需求、重要的安全/效能屬性不明或驗收不可測。  
- **MEDIUM**：術語不一致、非功能需求缺乏任務覆蓋、邊界情況未充分規定。  
- **LOW**：敘述風格或小重複，不影響執行順序。

### 6. 生產精簡分析報告

輸出 Markdown 報告（禁止寫檔）結構如下：

## Specification Analysis Report

| ID | 類別 | 嚴重度 | 位置 | 摘要 | 建議 |
|----|------|--------|------|------|------|
| A1 | Duplication | HIGH | spec.md:L120-134 | 兩個相似需求... | 合併敘述；保留較清楚版本 |

（針對每個發現產生一行，並給予穩定的 ID）

**覆蓋摘要表：**

| Requirement Key | 有任務覆蓋? | Task IDs | 備註 |
|-----------------|------------|----------|------|

**憲法對齊問題**（如有）：

**未映射任務**（如有）：

**指標：**

- 總需求數  
- 總任務數  
- 覆蓋率 %（有 >=1 任務的需求比率）  
- 模糊數量  
- 重複數量  
- 關鍵問題數（CRITICAL）

### 7. 提供後續行動

於報告末段給出簡潔的 Next Actions：

- 若存在 CRITICAL 問題：建議於執行 `/speckit.implement` 前先解決。  
- 若僅 LOW/MEDIUM：可繼續，但列出改進建議。  
- 提供顯式命令建議，例如：`Run /speckit.specify with refinement`、`Run /speckit.plan to adjust architecture`、`手動編輯 tasks.md 以補 coverage 'performance-metrics'` 等。

### 8. 提供補救選項（詢問使用者是否需要）

詢問使用者：「是否要我為 top N 問題建議具體補救編輯？」（**注意**：不要自動套用變更）

## 操作原則

### 上下文效率
- 以最少的 token 找出高訊號事項。  
- 逐步載入 artifact，避免整份 dump。  
- 輸出控制於 50 項發現內，溢位總結。  
- 保持結果可重現（無變更時重新執行應產生相同 ID 與計數）。

### 分析指引
- **絕不修改檔案**（唯讀）。  
- **不胡亂臆測缺失段落**（若缺，準確回報）。  
- 優先處理憲法違反（視為 CRITICAL）。  
- 以實例為主，不做空泛評論。  
- 若零問題，優雅輸出成功報告與覆蓋統計。

"""
