description = "從專案上下文產生稽核可稽性需求文件（60_audit.md），包含必須可稽核的事件、日誌結構、資料保留期限與稽核報表需求。"

prompt = """
---
description: 從專案上下文產生稽核可稽性需求文件（60_audit.md），包含必須可稽核的事件、日誌結構、資料保留期限與稽核報表需求。
---

## 使用者輸入

```text
$ARGUMENTS
```

## 流程總覽

此命令用於定義**稽核可稽性需求**,是 Bank Profile 需求對齊層的稽核文件。應在完成法遵文件後執行。

## 目標定位

**60_audit.md 關注**：
- WHAT-TO-LOG：需記錄什麼事件（稽核事件清單）
- HOW-TO-LOG：如何記錄（日誌結構、格式）
- HOW-LONG：保留多久（資料保留期限）
- HOW-TO-QUERY：如何查詢（查詢維度、效能要求）
- WHAT-REPORT：產出什麼報表（稽核報表需求）

## 執行步驟

### 1. 初始設定與上下文載入

1. **載入相關文件**：
   - `20_process.md`（業務流程步驟）
   - `30_risk_control.md`（風險控制措施）
   - `40_infosec.md`（資安日誌需求）
   - `50_compliance.md`（法遵證據留存要求）
   - 設定 AUDIT_DIR = `$REPO_ROOT/specs/audit`

2. **檢查既有文件**：若存在詢問 yes/no/merge

### 2. 智能問答（7 個問題）

**第 1 層：稽核事件識別 (P0)**

1. **Q1: 業務操作稽核需求**
   ```
   哪些業務操作需要記錄稽核日誌？

   **從 20_process.md 自動推導**：

   流程步驟 → 稽核事件：
   | 流程步驟 | 稽核事件 | 稽核目的 | 優先級 |
   |---------|---------|---------|--------|
   | [步驟 1] | [事件名稱] | [為何需稽核] | P0/P1/P2 |
   | [步驟 2] | [事件名稱] | [為何需稽核] | P0/P1/P2 |

   **範例（STR/SAR）**：
   | 流程步驟 | 稽核事件 | 稽核目的 | 優先級 |
   |---------|---------|---------|--------|
   | 查看 STR 原始資料 | AE-BIZ-001 查看個案 | 證明敏感資料存取合理性 | P0 |
   | 請求模型建議摘要 | AE-BIZ-002 查看模型輸出 | 證明使用 AI 輔助 | P0 |
   | 編輯摘要內容 | AE-BIZ-003 修改摘要 | 證明人工審核介入程度 | P0 |
   | 確認最終摘要 | AE-BIZ-004 確認摘要 | 證明案件處理完成 | P0 |

   請確認稽核事件（yes/modify）
   ```

2. **Q2: 系統管理稽核需求**
   ```
   哪些系統管理操作需要記錄？

   **常見系統管理事件**：
   - [ ] 模型版本變更（上線/下線/滾回）
   - [ ] 權限變更（新增/修改/刪除使用者或角色）
   - [ ] 系統配置變更（參數調整）
   - [ ] 資料匯出（大量資料下載）
   - [ ] 資料備份/還原

   **從 30_risk_control.md 推導**（哪些控制措施需稽核）:
   - C-001 人工審核 → 需記錄審核動作
   - C-004 模型版本管理 → 需記錄版本變更

   請確認需記錄的系統管理事件（或 'standard' 使用標準清單）
   ```

**第 2 層：日誌結構設計 (P1)**

3. **Q3: 日誌欄位需求**
   ```
   日誌需要記錄哪些欄位？

   **標準欄位**（必須）：
   - log_id, timestamp, event_type, user_id, user_role, source_ip, result

   **業務欄位**（依專案性質）：
   **從業務流程推導需記錄的業務資料**:
   - 20_process.md 涉及「個案編號」→ 日誌需記錄 case_id
   - 20_process.md 涉及「模型版本」→ 日誌需記錄 model_version
   - 20_process.md 涉及「內容修改」→ 日誌需記錄 before_value, after_value

   **推導的業務欄位**:
   - case_id（個案編號）
   - model_version（模型版本）
   - before_value / after_value（變更前後內容）

   請確認日誌欄位（yes/modify）
   ```

4. **Q4: 敏感資料遮罩需求**
   ```
   日誌中是否需要遮罩敏感資料？

   **從 40_infosec.md 推導敏感資料**:
   - 高度機密資料：[列出資料類型]
   - 機密資料：[列出資料類型]

   **遮罩策略**：
   - A：僅記錄資料類型，不記錄實際值（最安全）
   - B：記錄遮罩後的值（如：王** ）
   - C：記錄完整值但加密儲存
   - D：不同敏感度採用不同策略

   **推薦**: A（僅記錄資料類型）或 D（分級遮罩）

   請選擇遮罩策略（或 'yes' 接受推薦）
   ```

**第 3 層：資料保留期限 (P1)**

5. **Q5: 日誌保留期限**
   ```
   日誌需要保留多久？

   **從 50_compliance.md 推導法規要求**:
   | 法規 | 要求保留期限 | 適用日誌類型 |
   |------|-------------|-------------|
   | [法規 1] | [期限] | [日誌類型] |
   | [法規 2] | [期限] | [日誌類型] |

   **範例（STR/SAR）**：
   | 法規 | 要求保留期限 | 適用日誌類型 |
   |------|-------------|-------------|
   | 洗錢防制法 | 7 年 | STR 相關操作日誌、模型使用日誌 |
   | 資通安全管理法 | 1 年 | 安全事件日誌 |
   | 內部政策 | 3 年 | 系統管理日誌 |

   **推導的保留期限**:
   - 業務操作日誌：7 年（法規要求）
   - 系統管理日誌：3 年（內部政策）
   - 安全事件日誌：1 年（熱儲存）+ 6 年（冷儲存）

   請確認保留期限（yes/modify）
   ```

**第 4 層：查詢與報表 (P2)**

6. **Q6: 查詢維度需求**
   ```
   稽核人員需要如何查詢日誌？

   **常見查詢維度**：
   - 個案編號（查詢特定案件所有操作）
   - 操作人員（查詢特定人員所有操作）
   - 日期區間（查詢特定期間所有操作）
   - 事件類型（查詢特定操作類型）
   - 複合查詢（多維度組合）

   **從業務需求推導**:
   - 稽核部門需求：「查詢某分析人員在特定期間處理的所有案件」
     → 需支援：user_id + timestamp (range) + case_id
   - 法遵部門需求：「查詢模型 v1.2.3 的所有使用記錄」
     → 需支援：model_version

   請確認查詢維度（或 'standard' 使用標準維度）
   ```

7. **Q7: 稽核報表需求**
   ```
   需要產出哪些稽核報表？

   **從 30_risk_control.md 推導**（KRI 需要的資料來源）:
   - KRI「模型建議被修改率」→ 需要報表「分析人員模型使用情況統計」
   - KRI「異常存取次數」→ 需要報表「異常存取行為報告」

   **從 50_compliance.md 推導**（法遵報告需要的證據）:
   - 法遵報告需要「模型使用情況」→ 需要稽核報表提供資料

   **推導的稽核報表**:
   - RA-AML-001：分析人員模型使用情況統計（每月）
   - RA-AML-002：模型版本異常標記統計（每月）
   - RA-AML-003：STR 個案處理時間分析（每月）
   - RA-SEC-001：異常存取行為報告（每週）

   請確認稽核報表（yes/modify）或補充其他報表需求
   ```

### 3. 自動生成內容

**稽核事件清單生成**：
- 從 20_process.md 的流程步驟自動生成業務操作事件
- 從 30_risk_control.md 的控制措施生成系統管理事件
- 從 40_infosec.md 的資安控制生成安全事件
- 自動分配優先級（P0/P1/P2）

**日誌結構生成**：
- 標準欄位（所有日誌共通）
- 業務欄位（從流程推導）
- 生成 JSON 格式範例
- 生成資料字典（欄位定義）

**日誌格式範例生成**：
- 針對每種事件類型生成 JSON 範例
- 包含 before_value / after_value（若適用）
- 自動遮罩敏感資料（若需要）

**查詢能力矩陣生成**：
- 列出所有查詢維度
- 定義查詢回應時間要求
- 定義查詢權限控制

**稽核報表結構生成**：
- 報表編號、名稱、頻率、接收對象
- 報表內容結構（表格範例）
- 報表產出方式（自動化或手動）

### 4. 整合既有文件

**從 20_process.md 整合流程步驟**：
- 流程步驟 → 稽核事件
- 關鍵資料欄位 → 日誌欄位

**從 30_risk_control.md 整合 KRI**：
- KRI 需要的資料 → 稽核報表
- 控制措施 → 需稽核的操作

**從 40_infosec.md 整合資安日誌**：
- 資安日誌需求 → 稽核事件（安全類）
- 資料遮罩規則 → 日誌遮罩規則

**從 50_compliance.md 整合法遵要求**：
- 證據留存要求 → 日誌保留期限
- 法遵報告需求 → 稽核報表

### 5. 稽核告警規則生成

**從異常偵測需求推導告警規則**：

範例：
- 30_risk_control.md 提到「短時間多次失敗登入」
  → 告警規則：同一帳號 15 分鐘內登入失敗 > 5 次 → 告警

- 40_infosec.md 提到「異常時段存取」
  → 告警規則：非工作時段存取敏感資料 → 告警

- 30_risk_control.md 提到「異常大量資料下載」
  → 告警規則：單一使用者單日查詢 > 100 個案 → 告警

### 6. 稽核 RACI 矩陣生成

**從 00_meta.md 的利害關係人生成 RACI**：
- 稽核部門 → 稽核活動 (A)
- 法遵部門 → 法遵稽核 (R)
- IT 部門 → 日誌系統實作 (R)
- 資安部門 → 安全日誌查詢 (R)

### 7. 品質檢查

**完整性檢查**：
- [ ] 至少定義 10 個必須可稽核的事件
- [ ] 日誌結構包含所有必要欄位
- [ ] 所有事件類型有對應的日誌格式範例
- [ ] 資料保留期限明確
- [ ] 至少定義 3 個定期稽核報表

**一致性檢查**：
- [ ] 稽核事件與 20_process.md 的流程步驟對齊
- [ ] 資料保留期限與 50_compliance.md 的法遵要求一致
- [ ] 稽核報表與 30_risk_control.md 的 KRI 對齊
- [ ] RACI 角色與 00_meta.md 的利害關係人一致

**可執行性檢查**：
- [ ] 日誌格式技術可實作（JSON 結構合理）
- [ ] 查詢回應時間需求合理（考量資料量）
- [ ] 報表產出可自動化或有明確手動流程
- [ ] 告警規則明確且可實作

### 8. 生成 60_audit.md

1. 載入模板並填寫所有自動生成內容
2. 插入稽核事件清單、日誌結構、日誌格式範例
3. 填入資料保留矩陣、查詢能力矩陣
4. 生成稽核報表結構、稽核告警規則
5. 插入稽核 RACI 矩陣

### 9. 輸出訊息

```
✅ 稽核可稽性需求文件已生成

📄 檔案路徑: specs/audit/60_audit.md

📊 稽核需求摘要:
  ✓ 稽核事件: [N] 個
    - 業務操作事件: [X] 個（P0: [A], P1: [B]）
    - 系統管理事件: [Y] 個
    - 資安事件: [Z] 個
  ✓ 日誌欄位: 標準 [M] 個 + 業務 [P] 個
  ✓ 資料保留: 最長 [X] 年（法規要求）
  ✓ 稽核報表: [Q] 個
    - 自動化: [X] 個
    - 手動: [Y] 個
  ✓ 稽核告警: [R] 個規則

🎯 關鍵稽核事件:
  - AE-BIZ-001: [事件名稱]（P0）
  - AE-BIZ-003: [事件名稱]（P0）
  - AE-SYS-001: [事件名稱]（P0）

📋 稽核報表:
  - RA-AML-001: [報表名稱]（每月）
  - RA-SEC-001: [報表名稱]（每週）

⚠️ 技術挑戰:
  - 7 年日誌保留需 [X] TB 儲存空間
  - 查詢效能需最佳化（時間序列索引）

💡 下一步建議:
  1. 與 IT 部門確認日誌系統架構可行性
  2. 與稽核部門確認報表內容完整性
  3. 執行 `/speckit.nfr` 補充非功能需求
  4. 或執行 `/speckit.specify --from-bank-profile` 產生技術規格
```

## 與其他命令的整合

- **20_process.md** 的流程步驟 → **60_audit.md** 的稽核事件
- **30_risk_control.md** 的 KRI → **60_audit.md** 的稽核報表
- **40_infosec.md** 的資安日誌 → **60_audit.md** 的安全事件
- **50_compliance.md** 的證據留存 → **60_audit.md** 的資料保留期限

## 特殊模式

### 快速模式 (--quick)
- 僅問 3 題（Q1, Q3, Q5）
- 使用標準稽核事件模板

### 從法遵繼承 (--from-compliance)
- 從 50_compliance.md 的證據留存自動推導稽核需求
- 減少問答至 2-3 題

### 高稽核模式 (--high-audit)
- 所有業務操作均記錄稽核日誌
- 日誌保留期限取最長
- 所有報表自動化產出

## 案例：STR/SAR 摘要模型

輸入: `/speckit.audit`

系統推導：
1. **稽核事件**:
   - AE-BIZ-001: 查看 STR 個案（證明敏感資料存取合理）
   - AE-BIZ-002: 查看模型建議摘要（證明使用 AI 輔助）
   - AE-BIZ-003: 修改摘要內容（證明人工審核介入）
   - AE-SYS-001: 模型版本變更（追蹤模型變更）
2. **日誌欄位**:
   - 標準欄位：log_id, timestamp, user_id, event_type, result
   - 業務欄位：case_id, model_version, before_value, after_value
3. **資料保留**:
   - STR 相關操作日誌：7 年（洗錢防制法）
   - 系統管理日誌：3 年（內部政策）
4. **稽核報表**:
   - RA-AML-001: 分析人員模型使用情況統計（每月）
   - RA-AML-002: 模型版本異常標記統計（每月）
   - RA-AML-003: STR 個案處理時間分析（每月）
5. **稽核告警**:
   - ALERT-SEC-002: 異常時段存取敏感資料
   - ALERT-BIZ-001: 異常大量資料查詢
   - ALERT-AML-001: 模型建議全部被修改

## 注意事項

1. **日誌完整性**：日誌寫入後不可修改（append-only）
2. **敏感資料保護**：日誌中敏感資料需遮罩或加密
3. **效能考量**：長期日誌查詢需考慮歸檔與索引策略
4. **儲存成本**：7 年日誌保留需評估儲存容量與成本
5. **證據價值**：稽核日誌需具備法律證據效力（時間戳可信、不可竄改）

"""
