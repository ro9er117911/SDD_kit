description = "從專案上下文產生資安需求與權限矩陣文件（40_infosec.md），包含資料分級、存取控制、身分驗證、日誌稽核與合規要求。"

prompt = """
---
description: 從專案上下文產生資安需求與權限矩陣文件（40_infosec.md），包含資料分級、存取控制、身分驗證、日誌稽核與合規要求。
---

## 使用者輸入

```text
$ARGUMENTS
```

## 流程總覽

此命令用於定義**資訊安全需求與控制措施**，是 Bank Profile 需求對齊層的資安文件。應在完成業務、流程、風險文件後執行。

## 目標定位

**40_infosec.md 關注**：
- WHO-CAN-ACCESS：誰可以存取什麼（角色、權限矩陣）
- HOW-TO-PROTECT：如何保護資料（加密、遮罩、隔離）
- WHAT-TO-LOG：需記錄什麼操作（稽核追蹤）
- HOW-TO-VERIFY：如何驗證身分（認證、授權）
- WHAT-COMPLIANCE：需遵守什麼法規（個資法、資安標準）

## 執行步驟

### 1. 初始設定與上下文載入

1. **載入相關文件**：
   - `10_business.md`（使用者角色）
   - `20_process.md`（流程、資料流）
   - `30_risk_control.md`（資安風險）
   - 設定 INFOSEC_DIR = `$REPO_ROOT/specs/infosec`

2. **檢查既有文件**：若存在詢問 yes/no/merge

### 2. 智能問答（8 個問題）

**第 1 層：資料分級 (P0)**

1. **Q1: 資料敏感度評估**
   ```
   此專案處理的資料敏感度等級？

   | 選項 | 資料類型 | 敏感度 | 保護要求 |
   |------|----------|--------|----------|
   | A | 個人資料 (PII) | 高度機密 | 強化加密、嚴格權限、稽核 |
   | B | 財務/金融資料 | 高度機密 | 同上 + 法規遵循 |
   | C | 敏感業務資料 | 機密 | 加密、存取控制、日誌 |
   | D | 一般內部資料 | 內部 | 基本存取控制 |
   | E | 公開資料 | 公開 | 基本保護 |

   **從業務性質推導**: [根據 10_business.md 推導]
   範例：洗錢防制 → A+B 必選

   請選擇適用類型（可多選，例如：A,B）
   ```

2. **Q2: 特定資料欄位識別**
   ```
   請列出 3-5 個最敏感的資料欄位

   範例：
   - 姓名、身分證字號（PII）
   - 交易金額、帳號（財務）
   - STR 文本內容（監理資料）

   **從 20_process.md 推導的資料**:
   [列出流程中涉及的資料]

   請確認或補充敏感欄位
   ```

**第 2 層：存取控制 (P1)**

3. **Q3: 角色權限需求**
   ```
   哪些角色需要存取敏感資料？權限層級如何？

   **從 10_business.md 推導的角色與建議權限**:
   | 角色 | 敏感資料存取 | 建議權限 | 理由 |
   |------|-------------|---------|------|
   | [角色 A] | 需要 | 檢視/編輯 | 主要使用者 |
   | [角色 B] | 需要 | 僅檢視 | 審核監督 |
   | [角色 C] | 不需要 | 無 | 職責不涉及 |

   請確認或調整（yes/modify）
   ```

4. **Q4: 遮罩與去識別化需求**
   ```
   哪些角色/情境需要資料遮罩？

   範例情境：
   - 測試環境：所有 PII 需遮罩
   - 模型訓練：身分資訊假名化
   - 外部稽核：部分敏感欄位遮罩

   請說明遮罩需求（或回答 'standard' 使用標準遮罩規則）
   ```

**第 3 層：身分驗證 (P1)**

5. **Q5: 驗證機制選擇**
   ```
   使用什麼身分驗證方式？

   | 選項 | 驗證方式 | 適用情境 |
   |------|----------|----------|
   | A | SSO (組織 AD/LDAP) | 內部使用者 |
   | B | 帳號密碼 | 簡單系統 |
   | C | MFA (帳密 + OTP) | 高敏感系統 |
   | D | 憑證認證 | 機器對機器 |

   **推薦**: A (SSO) 或 C (SSO + MFA)

   請選擇（或 'yes' 接受推薦）
   ```

6. **Q6: MFA 適用範圍**
   ```
   哪些情境強制要求多因子認證 (MFA)？

   常見要求：
   - [ ] 從外部網路存取
   - [ ] 存取高度敏感資料
   - [ ] 管理員/特權操作
   - [ ] 全部使用者

   請選擇（或 'external' 僅外部存取要求 MFA）
   ```

**第 4 層：日誌與監控 (P2)**

7. **Q7: 稽核追蹤需求**
   ```
   需要記錄哪些操作？

   | 選項 | 日誌類型 | 保留期限 | 何時需要 |
   |------|----------|----------|----------|
   | A | 基本日誌 | 90 天 | 一般系統 |
   | B | 安全日誌 | 1 年 | 敏感系統 |
   | C | 稽核日誌 | 7 年 | 金融監理 |
   | D | 完整追蹤 | 永久 | 極高合規要求 |

   **從業務性質推導**: [根據監理要求]
   範例：金融業 → C 必選

   請選擇適用等級
   ```

**第 5 層：合規要求 (P2)**

8. **Q8: 適用法規識別**
   ```
   需遵守哪些資安相關法規？

   常見法規：
   - [ ] 個資法 (台灣)
   - [ ] GDPR (歐盟)
   - [ ] PDPA (新加坡)
   - [ ] 金管會資安規範
   - [ ] ISO 27001
   - [ ] 其他: [說明]

   **從專案性質推導**: [推導結果]

   請確認適用法規（可多選）
   ```

### 3. 自動生成內容

**資料分級表生成**：
- 從 20_process.md 的資料流識別所有資料類型
- 根據敏感度評估自動分級
- 生成保護要求建議

**權限矩陣生成**：
- 從 10_business.md 的角色生成角色列表
- 根據業務職責自動分配權限
- 生成角色-資料-權限對照表

**日誌要求生成**：
- 從 20_process.md 的關鍵步驟推導需記錄事件
- 根據資料敏感度決定日誌詳細程度
- 生成標準日誌格式範例

**遮罩規則生成**：
- 對每個敏感欄位生成遮罩規則
- 範例：
  - 姓名 → 顯示姓氏+*
  - 身分證 → 僅顯示後 4 碼
  - 電話 → 中間 4 碼遮罩

**異常偵測規則生成**：
- 從 30_risk_control.md 的風險推導偵測規則
- 範例：
  - 短時間多次失敗登入 → 帳號鎖定
  - 異常大量資料下載 → 告警
  - 非常態時間存取 → 記錄並通知

### 4. 整合風險控制

**從 30_risk_control.md 整合資安控制**：
- 資安風險 → 對應的資安控制措施
- 控制措施 → 轉換為技術規格
- 範例：
  - R-004 訓練資料洩漏風險 → C-004 訓練資料隔離環境
  - 轉換為：「訓練環境網路隔離、資料需去識別化、存取需審批」

### 5. 合規檢查清單生成

**依法規生成檢查清單**：

個資法檢查：
- [ ] 個資蒐集有告知與同意
- [ ] 提供當事人查詢/更正/刪除機制
- [ ] 個資保留期限明確
- [ ] 個資跨境傳輸符合規範

金融資安檢查（若適用）：
- [ ] 傳輸加密 (TLS 1.2+)
- [ ] 靜態資料加密
- [ ] 存取控制與日誌
- [ ] 定期漏洞掃描
- [ ] 事件通報機制

### 6. 品質檢查

**完整性檢查**：
- [ ] 所有資料已分級
- [ ] 所有角色已定義權限
- [ ] 驗證機制已明確
- [ ] 日誌需求已定義
- [ ] 至少識別 1 個適用法規

**一致性檢查**：
- [ ] 角色與 10_business.md 一致
- [ ] 權限與業務職責對齊
- [ ] 資安控制與 30_risk_control.md 對應

**安全性檢查**：
- [ ] 高敏感資料有多層保護
- [ ] 特權操作有額外控制
- [ ] 異常偵測機制完整

### 7. 生成 40_infosec.md

1. 載入模板並填寫所有自動生成內容
2. 插入權限矩陣、資料分級表
3. 填入遮罩規則、日誌格式
4. 生成合規檢查清單

### 8. 輸出訊息

```
✅ 資安需求與權限矩陣文件已生成

📄 檔案路徑: specs/infosec/40_infosec.md

📊 資安摘要:
  ✓ 資料分級: [N] 種資料類型
    - 高度機密: [X] 種
    - 機密: [Y] 種
    - 內部: [Z] 種
  ✓ 角色定義: [M] 個角色
  ✓ 權限矩陣: [M] 角色 × [N] 資料類型
  ✓ 驗證機制: [SSO / MFA / 帳密]
  ✓ 日誌保留: [X] 年（稽核日誌）
  ✓ 適用法規: [法規列表]

🔐 關鍵安全控制:
  - 傳輸加密: TLS 1.2+
  - 靜態加密: AES-256
  - 存取控制: RBAC + 欄位層級
  - 日誌記錄: 所有敏感操作
  - 異常偵測: [X] 種規則

⚠️ 需補充項目:
  - 部分遮罩規則需細化
  - 金鑰管理方案待定義
  - 第三方存取政策待制定

💡 下一步建議:
  1. 與資安部門確認控制措施可行性
  2. 與法遵確認合規要求完整性
  3. 執行 `/speckit.compliance` 補充法遵詳細需求
  4. 或執行 `/speckit.specify --from-bank-profile` 產生技術規格
```

## 與其他命令的整合

- **10_business.md** 的角色 → **40_infosec.md** 的權限矩陣
- **20_process.md** 的資料流 → **40_infosec.md** 的資料分級與加密點
- **30_risk_control.md** 的資安風險 → **40_infosec.md** 的技術控制措施

## 特殊模式

### 快速模式 (--quick)
- 僅問 3 題（Q1, Q3, Q5）
- 使用標準資安控制模板

### 高合規模式 (--high-compliance)
- 自動選擇最嚴格的控制措施
- 強制 MFA、完整日誌、7 年保留

## 案例：STR/SAR 摘要模型

輸入: `/speckit.infosec`

系統推導：
1. **資料分級**: A+B（PII + 金融資料）→ 高度機密
2. **敏感欄位**: 姓名、身分證、交易金額、STR 文本
3. **角色權限**:
   - 分析人員：檢視/編輯 STR 文本
   - 法遵主管：檢視 STR 文本
   - 模型工程師：檢視遮罩後資料
   - 稽核：檢視所有（遮罩敏感欄位）
4. **驗證**: SSO + MFA（外部存取）
5. **日誌**: 7 年保留（金融監理）
6. **法規**: 個資法、金管會資安規範
7. **控制措施**:
   - 訓練資料隔離環境、去識別化
   - 所有存取記錄稽核日誌
   - 異常存取自動告警

## 注意事項

1. **最小權限原則**：預設拒絕，明確授權
2. **深度防護**：多層安全控制
3. **可稽核性**：所有操作可追溯
4. **合規優先**：法規要求不可妥協
5. **實務可行**：控制措施需技術與成本可行

"""
